---
title: "Upgrade SQL"
author: "Enrique ESCOBAR"
date: "28-07-2016"
output: 
  html_document: 
    toc: yes
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library(ggplot2)
summary(cars)
qplot(speed, dist, data = cars) + geom_smooth()
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

# Analysis
```{r, echo=FALSE, error=FALSE}
# namespace
aNamespace <- "SqlODBC";
# path
if (Sys.getenv("AXONID") != "") {
  axonIDPath <- "";
  if (Sys.getenv("DataDrive") != "") {
    axonIDPath <- Sys.getenv("DataDrive");
  } else {
    axonIDPath <- Sys.getenv("SystemDrive");
  }
  axonIDPath <- paste0(c(axonIDPath, Sys.getenv("AXONID"), "R", aNamespace), sep = "/", collapse = "");
  setwd(axonIDPath);
}
getwd();
# base lib
gDriveUtil <- paste0(c("Lib/", "base", ".Util.R"), sep = "", collapse = "");
write(paste0(c("Load Util........\t", gDriveUtil), sep = "", collapse = ""), stdout());
source(gDriveUtil);
# RODBC lib
rodbcUtil <- paste0(c("Lib/", "RODBC", ".Util.R"), sep = "", collapse = "");
write(paste0(c("Load Util........\t", rodbcUtil), sep = "", collapse = ""), stdout());
source(rodbcUtil);
# ggplot2 lib
ggplot2Util <- paste0(c("Lib/", "ggplot2", ".Util.R"), sep = "", collapse = "");
write(paste0(c("Load Util........\t", ggplot2Util), sep = "", collapse = ""), stdout());
source(ggplot2Util);
# plotrix lib
plotrixUtil <- paste0(c("Lib/", "plotrix", ".Util.R"), sep = "", collapse = "");
write(paste0(c("Load Util........\t", plotrixUtil), sep = "", collapse = ""), stdout());
source(plotrixUtil);
# password
dbUser <- "sa";
dbPass <- GetDBPassword("AXONID_ENV");
# DB list
dbList <- c("mmq", "Claims_MMQ");
dbList <- sort(dbList);
# RODBC Open SimmqDB
library(RODBC);
simmqODBC <- odbcConnect("SimmqDB", uid = dbUser, pwd = dbPass);
```

## Setup R
The best tool to do statistical analysis and graph is R (integrated in SQL Server 2016).

## Screening Server

### Server Info
```{r}
# Server info
serverInstance <- SqlCountResultToString(simmqODBC, "Select @@SERVERNAME     AS SQLServerInstance;");
serverVersion <- SqlCountResultToString(simmqODBC, "Select @@VERSION        AS SQLServerVersion;");
serverService <- SqlCountResultToString(simmqODBC, "Select @@ServiceName    AS ServiceInstance;");
```

### Server Running
```{r}
# Server Running
sqlFile <- "SQL/DB-ServerRunning_list.sql";
sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
sqlDataFrame;
```

### Server Linked
```{r}
# Server Linked
sqlFile <- "SQL/DB-ServerLinked_list.sql";
sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
sqlDataFrame;
```

### Server Spec
```{r}
# Server DB spec
sqlFile <- "SQL/DB-ServerDBSpec_list.sql";
sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
sqlDataFrame;
```

### Server Backup
```{r}
# Server DB Backup
sqlFile <- "SQL/DB-ServerDBBackup_list.sql";
sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
sqlDataFrame;
```

### Server Usage
```{r}
## Server DB Usage
# Server DB usage list
sqlFile <- "SQL/DB-Usage_list.sql";
sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
sqlDataFrame;
# DB usage barplot
# titles
xTitle <- colnames(sqlDataFrame)[2];
yTitle <- colnames(rev(sqlDataFrame)[1]);
mainTitle <- "Usage List count";
# graph
barplot <- ggplot(sqlDataFrame, aes(x = factor(DBName), y = DBBufferMB)) +
  geom_bar(stat = "identity", width = 0.8, position = "dodge", fill = "lightblue") +
  xlab(xTitle) + ylab(yTitle) + ggtitle(mainTitle) +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5));
barplot;
```

## Screening Model
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
}
```

### Object Analysis
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## DB Object
  # DB object list
  sqlFile <- "SQL/DB-Object_list.sql";
  objectListDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(objectListDataFrame);
  # DB object list sum fonctions
  objectSumDataFrame <- SummarizeDBFunctionDataFrame(objectListDataFrame, "Function");
  head(objectSumDataFrame);
  # titles
  xTitle <- colnames(objectSumDataFrame)[1];
  yTitle <- colnames(objectSumDataFrame)[-1];
  mainTitle <- "ObjectList count";
  # graph
  barplot <- ggplot(objectSumDataFrame, aes(x = factor(ObjectName), y = ObjectCount)) +
    geom_bar(stat = "identity", width = 0.8, position = "dodge", fill = "lightblue") +
    xlab(xTitle) + ylab(yTitle) + ggtitle(mainTitle);
  barplot;
  # DB object list all fonctions
  objectAllDataFrame <- SummarizeAllDBFunctionDataFrame(objectListDataFrame, "Function");
  head(objectAllDataFrame);
  # titles
  xTitle <- colnames(objectAllDataFrame)[1];
  yTitle <- colnames(objectAllDataFrame)[-1];
  mainTitle <- "Function Types Barplot";
  # graph
  aBarplot <- ggplot(objectAllDataFrame,
                     aes(x = "", y = FunctionCount, fill = FunctionTypes)) +
    labs(fill = xTitle) + geom_bar(width = 1, stat = "identity") +
    xlab(xTitle) + ylab(yTitle) + ggtitle(mainTitle);
  aBarplot;
  PercentList <- round(objectAllDataFrame$FunctionCount / sum(objectAllDataFrame$FunctionCount) * 100);
  ColorList <- c("#66FF99", "#6699CC", "#FF5050");
  # titles
  xTitle <- colnames(objectAllDataFrame)[1];
  yTitle <- colnames(objectAllDataFrame)[-1];
  mainTitle <- "Function Type List Piechart";
  # graph
  pie3D(objectAllDataFrame$FunctionCount,
        labels = paste(objectAllDataFrame$FunctionTypes, paste("%", PercentList)),
        main = mainTitle,
        theta = pi / 3,
        col = ColorList);
}
```

### Procedure Analysis
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## DB StoredProc
  # DB StoreProc count
  sqlFile <- "SQL/DB-Procedure_count.sql";
  countStoreProc <- SqlCountResultToInteger(simmqODBC, GetSqlFromFile(sqlFile));
  # DB StoreProc list
  sqlFile <- "SQL/DB-Procedure_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB StoreProc param list
  sqlFile <- "SQL/DB-Procedure_listParams.sql";
  storedProcParamDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(storedProcParamDataFrame);
  storedProcParamDataFrameSlim <- DataFrameFromColumns(storedProcParamDataFrame,
                                                        "ProcedureName",
                                                        "ProcedureType",
                                                        "ProcedureDesc");
  head(storedProcParamDataFrameSlim);
  # DB StoreProc repeat count
  storedProcParamDataFrameFat <- aggregate(list(NbParameters = rep(1, nrow(storedProcParamDataFrameSlim))),
                                            storedProcParamDataFrameSlim,
                                            length);
  head(storedProcParamDataFrameFat);
  write(summary(rev(storedProcParamDataFrameFat)[1]), stdout());
  # DB StoreProc with params
  countStoreProcWith <- nrow(storedProcParamDataFrameFat);
  # DB StoreProc without params
  countStoreProcWithout <- countStoreProc - countStoreProcWith;
  # DB StoreProc data frame params
  storeProcParamsDF <- DataFrameWithoutWithTotal(countStoreProcWithout,
                                                 countStoreProcWith,
                                                 countStoreProc,
                                                 "StoreProc");
  # DB StoreProc param list export
  head(storeProcParamsDF);
  # DB StoreProc barplot
	OutputType <- "StoredProc";
	# rm totals/ last column & save colnames
	storeProcParamsDF <- rev(storeProcParamsDF)[-1];
	myColNames <- colnames(storeProcParamsDF);
	# rm colname and transpose and rm new colname
	colnames(storeProcParamsDF) <- NULL;
	storeProcParamsDF <- t(storeProcParamsDF);
	colnames(storeProcParamsDF) <- NULL;
	# add columns and replace colname 
	storeProcParamsDF <- cbind(myColNames, storeProcParamsDF);
	colnames(storeProcParamsDF) <- NULL;
	colnames(storeProcParamsDF) <- c(paste0(OutputType, "Types"), paste0(OutputType, "Count"));
	# cast to data frame
	storeProcParamsDF <- as.data.frame(storeProcParamsDF);
	# check colname
	write(colnames(storeProcParamsDF), stdout());
	# titles
	xTitle <- colnames(storeProcParamsDF)[1];
	yTitle <- colnames(storeProcParamsDF)[-1];
	mainTitle <- paste0(OutputType, " Type List Barplot");
	# graph
	aBarplot <- ggplot(storeProcParamsDF,
				aes(x = "", y = StoredProcCount, fill = StoredProcTypes)) +
				labs(fill = xTitle) + geom_bar(width = 1, stat = "identity") +
				xlab(xTitle) + ylab(yTitle) + ggtitle(mainTitle);
	aBarplot;
  # DB StoreProc boxplot
	# titles
	xTitle <- "Procedure type";
	yTitle <- "Number of parameters";
	mainTitle <- "Boxplot for parameter distribution";
	# graph
	aBoxplot <- ggplot(storedProcParamDataFrameFat, aes(x = ProcedureType, y = NbParameters)) +
		geom_boxplot(aes(fill = ProcedureType)) + geom_jitter() +
		# + geom_point(aes(colour = factor(type_desc)), size=4)
		scale_y_continuous(breaks = seq(0, 12, 1.0)) + labs(title = mainTitle, x = xTitle, y = yTitle);
	aBoxplot;
  # DB StoreProc density plot
	# titles
	xTitle <- "Number of parameters";
	mainTitle <- "Densityplot for parameter distribution";
	# graph
	aDensityplot <- ggplot(storedProcParamDataFrameFat, aes(NbParameters, fill = ProcedureType)) +
					geom_density(alpha = 0.6) + labs(title = mainTitle, x = xTitle);
	aDensityplot;
}
```

### DB Analysis
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## DB Table Count
  # DB Table Count DROP
  sqlQuery(simmqODBC, "IF OBJECT_ID(N'#counts', N'U') IS NOT NULL DROP TABLE #counts;")
  # DB TABLE Count CREATE
  sqlQuery(simmqODBC, "CREATE TABLE #counts (TableName VARCHAR(255), TableRows INT);");
  # DB Table Count EXEC
  sqlQuery(simmqODBC, "EXEC sp_MSForEachTable @command1='INSERT #counts (TableName, TableRows) SELECT ''?'', COUNT(*) FROM ?';");
  # DB Table Count CSV
  sqlFile <- "SQL/DB-RowCount_list.sql";
  tableRowCountDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(tableRowCountDataFrame);
  # DB Table Count repeats
  tableRowCountDataFrame <- aggregate(list(RowRepeats = rep(1, nrow(tableRowCountDataFrame[-1]))),
                                   tableRowCountDataFrame[-1],
                                   length);
  head(tableRowCountDataFrame);
  # DB Table Count half > mean repeats
  aMean <- mean(tableRowCountDataFrame$RowRepeats);
  tableRowCountDataFrame <- subset(tableRowCountDataFrame, RowRepeats > aMean);
  head(tableRowCountDataFrame);
	# titles
	xTitle <- colnames(tableRowCountDataFrame)[1];
	yTitle <- colnames(rev(tableRowCountDataFrame)[1]);
	mainTitle <- "Row List count";
	# graph
	barplot <- ggplot(tableRowCountDataFrame, aes(x = factor(TableRows), y = RowRepeats)) +
				##barplot <- ggplot(tableRowCountDataFrame, aes(x = factor(TableRows), y = sqrt(RowRepeats))) +
				geom_bar(stat = "identity", width = 0.8, position = "dodge", fill = "lightblue") +
				##scale_y_sqrt(paste0("Square root of ", yTitle)) +
				xlab(xTitle) + ylab(yTitle) + ggtitle(mainTitle) +
				theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5));
	barplot;
  # DB Table Count DROP
  sqlQuery(simmqODBC, "DROP TABLE #counts;");
}
```

### Table Analysis
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## DB Table Analysis
  # DB Table Analysis count
  sqlFile <- "SQL/DB-Table_count.sql";
  countTable <- SqlCountResultToInteger(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB Table Analysis list
  sqlFile <- "SQL/DB-Table_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB Table Analysis Independent
  sqlFile <- "SQL/DB-TableIndependent_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB Table Analysis Trunk
  sqlFile <- "SQL/DB-TableTrunk_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB Table Analysis Branch
  sqlFile <- "SQL/DB-TableBranch_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB Table Analysis Leaf
  sqlFile <- "SQL/DB-TableLeaf_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB Table Analysis Parent
  sqlFile <- "SQL/DB-TableParent_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB Table Analysis Child
  sqlFile <- "SQL/DB-TableChild_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB Table Analysis SelfRef
  sqlFile <- "SQL/DB-TableSelfRef_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # DB Table Analysis keys list
  sqlFile <- "SQL/DB-Table_listKeys.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
}
```
#### Table List

#### Table Independent List
Verify if empty or not used.

#### Table Trunk List
Verify if empty or not used.
Verify if FK point to indexed columns.
Verify if PK is indexed.

#### Table Branch List
Verify if empty or not used.
Verify if FK point to indexed columns.

#### Table Leaf List
Verify if empty or not used.
Verify if FK point to indexed columns.
Verify if PK is indexed.

#### Table Parent List
Verify if empty or not used.
Verify if PK is indexed.

#### Table Child List
Verify if empty or not used.
Verify if FK point to indexed columns.

#### Table SelfRef List
Verify if empty or not used.
Verify if FK point to indexed columns.
Verify if PK is indexed.

#### Table Key List
Verify if FK point to indexed columns.
Verify if PK is indexed.

### View Analysis
Check if they are indexable or indexed, index them if needed to increase performance.
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## View Analysis
  # View Analysis count
  sqlFile <- "SQL/DB-View_count.sql";
  countView <- SqlCountResultToInteger(simmqODBC, GetSqlFromFile(sqlFile));
  # View Analysis list
  sqlFile <- "SQL/DB-View_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
}
```

### Function Analysis

#### Function Type List
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## Function Analysis
  # Function Analysis count
  sqlFile <- "SQL/DB-Function_count.sql";
  countFunc <- SqlCountResultToInteger(simmqODBC, GetSqlFromFile(sqlFile));
  # Function Analysis list
  sqlFile <- "SQL/DB-Function_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
}
```

#### Function Parameter List
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  # Function Analysis param list
  sqlFile <- "SQL/DB-Function_listParams.sql";
  functionParamsDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(functionParamsDataFrame);
  fnParamsDataFrameSlim <- DataFrameFromColumns(functionParamsDataFrame,
                                                "FunctionName",
                                                "FunctionType",
                                                "FunctionDesc");
  head(fnParamsDataFrameSlim);
  # Function Analysis repeat count
  fnParamsDataFrameFat <- aggregate(list(NbParameters = rep(1, nrow(fnParamsDataFrameSlim))),
                                    fnParamsDataFrameSlim,
                                    length);
  write(summary(rev(fnParamsDataFrameFat)[1]), stdout());
  # Function Analysis without params
  countFuncWith <- nrow(fnParamsDataFrameFat);
  # Function Analysis without params
  countFuncWithout <- countFunc - countFuncWith;
  # Function Analysis data frame params
  fnParamsDF <- DataFrameWithoutWithTotal(countFuncWithout,
                                          countFuncWith,
                                          countFunc,
                                          "Fn");
  # Function Analysis param list export
  head(fnParamsDF);
  # Function Analysis barplot
	OutputType <- "Fn";
	# rm totals/ last column & save colnames
	fnParamsDF <- rev(fnParamsDF)[-1];
	myColNames <- colnames(fnParamsDF);
	# rm colname and transpose and rm new colname
	colnames(fnParamsDF) <- NULL;
	fnParamsDF <- t(fnParamsDF);
	colnames(fnParamsDF) <- NULL;
	# add columns and replace colname 
	fnParamsDF <- cbind(myColNames, fnParamsDF);
	colnames(fnParamsDF) <- NULL;
	colnames(fnParamsDF) <- c(paste0(OutputType, "Types"), paste0(OutputType, "Count"));
	# cast to data frame
	fnParamsDF <- as.data.frame(fnParamsDF);
	# check colname
	write(colnames(fnParamsDF), stdout());
	# titles
	xTitle <- colnames(fnParamsDF)[1];
	yTitle <- colnames(fnParamsDF)[-1];
	mainTitle <- paste0(OutputType, " Type List Barplot");
	# graph
	aBarplot <- ggplot(fnParamsDF, aes(x = "", y = FnCount, fill = FnTypes)) +
				labs(fill = xTitle) + geom_bar(width = 1, stat = "identity") +
				xlab(xTitle) + ylab(yTitle) + ggtitle(mainTitle);
	aBarplot;
  # Function Analysis boxplot
	xTitle <- "Function type";
	yTitle <- "Number of parameters";
	mainTitle <- "Boxplot for parameter distribution";
	# graph
	aBoxplot <- ggplot(fnParamsDataFrameFat, aes(x = FunctionType, y = NbParameters)) +
				geom_boxplot(aes(fill = FunctionType)) + geom_jitter() +
	# + geom_point(aes(colour = factor(type_desc)), size=4)
				scale_y_continuous(breaks = seq(0, 12, 1.0)) + labs(title = mainTitle, x = xTitle, y = yTitle);
	aBoxplot;
  # Function Analysis density plot
	# titles
	xTitle <- "Number of parameters";
	mainTitle <- "Densityplot for parameter distribution";
	# graph
	aDensityplot <- ggplot(fnParamsDataFrameFat, aes(NbParameters, fill = FunctionType)) +
					geom_density(alpha = 0.6) + labs(title = mainTitle, x = xTitle);
	aDensityplot;
}
```
Check why certain procedures have so many parameters.

### Principal Key Analysis
Check if all are used nor indexed.
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## PKey Analysis
  # PKey Analysis count
  sqlFile <- "SQL/DB-PKeys_count.sql";
  countPKeys <- SqlCountResultToInteger(simmqODBC, GetSqlFromFile(sqlFile));
  # PKey Analysis list
  sqlFile <- "SQL/DB-PKeys_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
}
```

### Foreign Key Analysis
Check if all are used nor indexed nor trusted.
Verify tables if ON Delete CASCADE.
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## FKey Analysis
  # FKey Analysis count
  sqlFile <- "SQL/DB-FKeys_count.sql";
  countFKeys <- SqlCountResultToInteger(simmqODBC, GetSqlFromFile(sqlFile));
  # FKey Analysis list
  sqlFile <- "SQL/DB-FKeys_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
}
```

### Index Analysis

#### Index List
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## Index Analysis
  # Index Analysis count
  sqlFile <- "SQL/DB-Index_count.sql";
  countIndex <- SqlCountResultToInteger(simmqODBC, GetSqlFromFile(sqlFile));
  # Index Analysis list
  sqlFile <- "SQL/DB-Index_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
  # Index Analysis type list
  sqlFile <- "SQL/DB-Index_listTypes.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
}
```
Verify Constraint Type.
Verify if can lock page.

#### Index Type List
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  # Index Analysis type list
  sqlFile <- "SQL/DB-Index_listTypes.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
}
```
Verify Index Type.
Verify if indexed.

### Constraint Analysis
Validate if constraint is respected.
```{r}
###
for (dbInstance in dbList) {
  write(dbInstance, stdout());
  # select DB
  sqlInstance <- paste0(c("USE ", dbInstance, ";"), sep = "", collapse = "");
  # write(sqlInstance, stdout());
  sqlQuery(simmqODBC, sqlInstance);
  ## Constraint Analysis
  # Constraint Analysis List
  sqlFile <- "SQL/DB-Constraint_list.sql";
  sqlDataFrame <- SqlResultToDataFrame(simmqODBC, GetSqlFromFile(sqlFile));
  head(sqlDataFrame);
}
# RODBC close SimmqDB
odbcClose(simmqODBC);
```


## Screening Code Calls
The minimum DB structure to have is to find al calls to DB from code.

### VB.NET Files
```{shell}
find /mnt/C/Disk_X/axon/mmqclaims -name "*.vb" | cat | while read i ; do echo "$i" ; done > Claims_MMQ-VB.NET_files.txt
```

### C# Files
```{shell}
find /mnt/C/Disk_X/axon/mmqclaims -name "*.cs" | cat | while read i ; do echo "$i" ; done > Claims_MMQ-CSharp_files.txt
```

### Java Files
```{shell}
find /mnt/C/Disk_X/axon/autoquick -name "*.java" | cat | while read i ; do echo "$i" ; done > mmq-Java_files.txt
```
